<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  doge1024
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="doge1024" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
 
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="https://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; doge1024</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
	$(function(){
		$('#menu_item_index').addClass('is_active');
	});
</script>
<div class="row">
	<div class="large-8 medium-8 columns">
		<div class="markdown-body home-categories">
		
			<div class="article">
                <a class="clearlink" href="2020-05-27%2010%3A54%3A36.html">
                
                  <h1>WebStorm调试ReactNative</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h3 id="toc_0">如何使用webstorm调试：</h3>

<ol>
<li>在任意位置添加debug的红点

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                   <a href="2020-05-27%2010%3A54%3A36.html">Read more</a>&nbsp;&nbsp; 
                    <span class="date">2020/05/27</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2020-05-27%2010%3A45%3A10.html">
                
                  <h1>codepush服务变更，连接不上</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>后台codepush的服务器地址变了，连接不上，不能退出<br/>
删除本地<code>./.code-push.config</code>文件解决</p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/05/27</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2020-03-28%2014%3A20%3A52.html">
                
                  <h1>小米手机安装linuxdeploy碰到的问题</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h3 id="toc_0">发生的错误</h3>

<p>设置好配置，进行安装时报以下错误</p>

<pre><code class="language-text">Mounting partitions :
/ ... fail
</code></pre>

<p>打开调试模式后</p>

<pre><code class="language-text">Mounting partitions:  
/ ... mount: mounting /dev/loop0 on /data/local/mnt failed: invalid argument
fail 
</code></pre>

<h3 id="toc_1">解决方法</h3>

<p>点击右下角设置按钮，将安装类型设置为 &quot;目录&quot;，返回重新安装可以成功</p>

<p>参考文章：<br/>
<a href="https://cloud.tencent.com/developer/article/1159800">https://cloud.tencent.com/developer/article/1159800</a><br/>
<a href="https://pluhuxc.github.io/2020/10/23/linuxdeploy-guide.html">https://pluhuxc.github.io/2020/10/23/linuxdeploy-guide.html</a><br/>
<a href="https://www.tkdcz.top/post/48.html">https://www.tkdcz.top/post/48.html</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/03/28</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2020-01-19%2001%3A09%3A37.html">
                
                  <h1>macOS 10.15 pip 安装库失败提示SSL</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">pip安装第三方库失败</h2>

<p>今天安装 <code>frida-tools</code> 时一直提示失败<br/>
其中错误有一句:<br/>
<code>error: &lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed</code></p>

<p>或者：</p>

<pre><code class="language-text">$ /usr/bin/python3 -c &#39;import urllib.request; urllib.request.urlopen(&quot;https://www.apple.com/&quot;)&#39;
...
urllib.error.URLError: &lt;urlopen error [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1056)&gt;
</code></pre>

<blockquote>
<p>我的系统环境：<br/>
macOS Catalina 10.15.2 (19C57)<br/>
已安装Xcode11，并且Xcode有带Python3.7</p>
</blockquote>

<h2 id="toc_1">解决方案</h2>

<p>执行以下两行命令：</p>

<pre><code class="language-text">/usr/bin/sudo /bin/mkdir /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/etc
/usr/bin/sudo /bin/ln -s /etc/ssl/ /Applications/Xcode.app/Contents/Developer/Library/Frameworks/Python3.framework/Versions/3.7/etc/
</code></pre>

<p>我出问题时的Xcode，默认是没有<code>/etc</code>这个目录的；使用以上命令后，可以正常安装<code>frida-tools</code></p>

<h4 id="toc_2">参考文章</h4>

<p><a href="https://stackoverflow.com/questions/57630314/ssl-certificate-verify-failed-error-with-python3-on-macos-10-15">ssl-certificate-verify-failed-error-with-python3-on-macos-10-15</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2020/01/19</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-08-06%2001%3A24%3A23.html">
                
                  <h1>读《时间简史》— 解释你无聊时的那些遐想</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>《时间简史》讲述是探索时间和空间核心秘密的故事，是关于宇宙本性的最前沿知识，包括我们的宇宙图像、空间和时间、膨胀的宇宙不确定性原理、基本粒子和自然的力、黑洞、黑洞不是这么黑、时间箭头等内容。</p>

<p>原先看过一点但是感觉有点枯燥，跟视频比起来缺少了些生动震撼的场面，不太好理解，这次看的是插画版的，会容易接受很多。所以如果想看的话，推荐看插画版的。</p>

<p>如果不太喜欢文字的描述，这里推荐一部视频 <a href="https://www.bilibili.com/video/av1935063/">《宇宙的构造》</a>，看完视频后会激起你对宇宙探索的欲望，再来看书会好些。视频里面讲解的也很好。</p>

<h2 id="toc_0">有几个孩子，能抵御星空的诱惑呢 ~</h2>

<p>小时候特喜欢去房顶上躺着，微风，虫鸣，不知不觉眼镜就看向了天空：天这么大，这么远，天上有云有星，但是天是什么？天的外面又是什么？经常看的《走进科学》里面的那些事是不是真的？51区又有多少外星生命来过？</p>

<p>前些日子无聊又看了一遍(我自封的)古装情景喜剧的巅峰《武林外传》，里面吕秀才有句台词：“我和宇宙有必然的联系吗？宇宙是否有尽头，时间是否有长短，过去的时间在哪里消失了，未来的时间又在何处停止，我在这一刻提出的问题，还是你刚才听到的问题吗？”。这句话第一次看的时候可能感叹编剧的厉害，对秀才这个读书人刻画的太好了，一笑而过，但是这次看却让我心里一颤，这不就是我小时候对世界的疑问么。</p>

<p>解决自己一直以来的疑问，解释自己无聊时的那些遐想，这就是我读这本书的原因。</p>

<h2 id="toc_1">书中的答案</h2>

<p>“四方上下曰宇，往古来今曰宙”，这句话太经典了，作为比较朴素的对宇宙的解释，可以帮助我们了解宇宙，但是还是有点笼统，有些哲学意味。</p>

<p>下面简单写一些问题在书中的答案。一切了解均是在学习，所以引用原文来解答。</p>

<h4 id="toc_2">宇宙是如何诞生的？</h4>

<p>引书中言：</p>

<blockquote>
<p>1983年，林德提出了一个更好的所谓混沌暴胀模型。这里没有相变和过冷，而代之以存在一个自旋为0的场，由于它的量子涨落，在早期宇宙的某些区域有大的场值。在那些区域中，场的能量起到宇宙常数的作用，它具有排斥的引力效应，而使这些区域以暴胀的形式膨胀。随着它们膨胀，它们中的场的能量慢慢地减小，直到暴胀改变到犹如热大爆炸模型中的膨胀时为止。这些区域之一就成为可观察的宇宙让我们看到。</p>
</blockquote>

<p>量子涨落，是从真空中爆发能量，在空间生成了由粒子和反粒子组成的虚粒子对。粒子对借取能量而生成，又在短时间内湮灭归还能量。这些产生的虚粒子的物理效应是可以被测量和观测的。也就是说真空不是真的空无一物</p>

<h4 id="toc_3">宇宙的的外面是什么？</h4>

<p>引书中言：</p>

<blockquote>
<p>人们可以说：“宇宙的边界条件是它没有边界。”宇宙便是完全自足的，而不受任何外在于它的东西影响。它既不被创生，也不被消灭。它就是存在。</p>
</blockquote>

<h4 id="toc_4">是否存在造物主？</h4>

<p>引书中言：</p>

<blockquote>
<p>只要宇宙有一个开端，我们就可以设想存在一个造物主。但是，如果宇宙的的确确是完全自足的，没有边界或边缘，它就既没有开端也没有终结：它就是存在。那么，还会有造物主存身之处吗？</p>
</blockquote>

<h4 id="toc_5">时间是否有起点？</h4>

<p>引书中言：</p>

<blockquote>
<p>所有的弗里德曼解都具有一个特点，即在过去的某一时刻（约100亿至200亿年之前）邻近星系之间的距离一定为零。在这被我们称之为大爆炸的那一时刻，宇宙的密度和时空曲率都是无限大。因为数学不能真正地处理无限大的数，这意味着，广义相对论（弗里德曼解以此为基础）预言，在宇宙中存在一点，在该处理论本身崩溃。这样的点正是数学中称为奇点的一个例子。事实上，我们所有的科学理论都是基于时空是光滑的和几乎平坦的基础上表述的，所以它们在时空曲率为无限大的大爆炸奇点处崩溃。这意味着，即使在大爆炸前存在事件，人们也不能用它们去确定其后所要发生的事件，因为可预见性在大爆炸处崩溃了。</p>

<p>我们只知道在大爆炸后发生的事件，我们就不能确定在这之前发生什么。就我们而言，大爆炸之前的事件不能有后果，所以并不构成我们宇宙的科学模型的一部分。因此，我们应将它们从模型中割除掉，并宣称时间是从大爆炸开始的。</p>
</blockquote>

<h4 id="toc_6">宇宙是否有终点？</h4>

<p>引书中言：</p>

<blockquote>
<p>1915年之前，空间和时间被认为是事件在其中发生的固定舞台，而它们不受在其中发生的事件的影响。即便在狭义相对论中，这也是对的。物体运动，力吸引并排斥，但时间和空间则完全不受影响地延伸着。空间和时间很自然地被认为无限地向前延伸。<br/>
然而在广义相对论中，情况则完全不同。这时，空间和时间变成为动力量：当物体运动，或者力作用时，它影响了空间和时间的曲率；反过来，时空的结构影响了物体运动和力作用的方式。空间和时间不仅去影响、而且被发生在宇宙中的每一件事影响。正如人们没有空间和时间的概念不能谈论宇宙的事件一样，同样地，在广义相对论中，在宇宙界限之外讲空间和时间也是没有意义的。</p>

<p>罗杰·彭罗斯和我证明了，爱因斯坦广义相对论意味着，宇宙必须有个开端，并且可能有个终结。</p>
</blockquote>

<h4 id="toc_7">可否实现时间旅行？</h4>

<p>如果可以进行时间旅行，为什么没有未来的人来告诉我们如何做呢？为什么地球没有被从未来旅行来的人挤爆？<br/>
到写文时间为止，时间旅行机器应该都没有被发明出来。</p>

<blockquote>
<p>任何时间旅行都被限制于未来。</p>

<p>黑洞辐射表明，量子理论在微观尺度上允许在时间中的往回运动，而且这种时间旅行能产生可观测的效应。</p>
</blockquote>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/08/06</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-07-10%2011%3A10%3A07.html">
                
                  <h1>iOS 禁用黑暗模式</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<p>如果你的公司没有设计黑暗模式，在iOS13到来之际，你需要在应用内禁止一下黑暗模式的显示：<br/>
在程序的Info.plist文件中加入:</p>

<p>key: <code>UIUserInterfaceStyle</code><br/>
value: <code>Light</code></p>

<p><img src="https://upload-images.jianshu.io/upload_images/1300265-6b528dd2af04f202.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1249" alt="image.png"/></p>

<p>参考：<br/>
<a href="https://developer.apple.com/documentation/appkit/supporting_dark_mode_in_your_interface/choosing_a_specific_interface_style_for_your_ios_app">苹果文档，只支持正常模式</a><br/>
<a href="https://developer.apple.com/documentation/appkit/supporting_dark_mode_in_your_interface">想去支持黑暗模式，查看文档</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/07/10</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-06-20%2014%3A44%3A49.html">
                
                  <h1>macOS 存储空间越来越少, 删完不增加可用空间</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h2 id="toc_0">问题</h2>

<p><code># macOS Catalina 10.15 beta 1 #</code> <br/>
升级 macOS Catalina 10.15 beta 1 后发现存储空间越来越少，怎么删除文件都不管用。文件越删越多。</p>

<h2 id="toc_1">原因</h2>

<p>因为 Time Machin 的 <code>local snapshots</code>(本地快照功能)，在你打开自动备份，但是没有接入任何硬盘的时候，系统会从本地创建并存储快照。<br/>
按道理来说此项功能很好，可以帮一些没有或者忘记带硬盘的人自动备份，而且对用户来说应该是不占用存储空间的。<br/>
<strong>但是</strong> 显然新系统出现了bug，导致了存储空间不能得到及时释放的情况。</p>

<p>从苹果官网的解释是：</p>

<blockquote>
<p>### How local snapshots use storage space<br/>
You don&#39;t need to think about how much storage space local snapshots are using, because they don&#39;t use space needed for tasks like downloading files, copying files, or installing new software.</p>

<p>Your Mac counts the space used by snapshots as available storage. Even so, Time Machine stores snapshots only on disks that have plenty of free space, and it automatically deletes snapshots as they age or as space is needed for other things.</p>
</blockquote>

<p>google 翻译：</p>

<blockquote>
<h3 id="toc_2">本地快照如何使用存储空间</h3>

<p>您无需考虑本地快照正在使用多少存储空间，因为它们不会使用下载文件，复制文件或安装新软件等任务所需的空间。</p>

<p>您的Mac将快照使用的空间计为可用存储空间。即便如此，Time Machine仅将快照存储在具有足够可用空间的磁盘上，并且在它们老化或其他内容需要空间时自动删除快照。搜索</p>
</blockquote>

<p>可以google自己搜索关键字 <a href="https://www.google.com/search?newwindow=1&amp;rlz=1C5CHFA_enUS691US691&amp;ei=xyMLXcTkHMqU-gSQrZ2YDw&amp;q=About+Time+Machine+local+snapshots&amp;oq=About+Time+Machine+local+snapshots&amp;gs_l=psy-ab.3...0.0..231404...0.0..0.0.0.......0......gws-wiz.kx7n-Vqtt_M">About Time Machine local snapshots</a>，苹果官网的<a href="https://support.apple.com/en-us/HT204015">文章</a>已经删除，可以通过网页快照查看。</p>

<h2 id="toc_3">解决方案：</h2>

<h5 id="toc_4">如果你的电脑已经剩余空间太少，导致开不开机，请使用 Time Machine ，进行恢复。以下解决方案仅适用可开机用户</h5>

<ul>
<li><h6 id="toc_5">小白大神皆可使用：</h6>
<ol>
<li> 从菜单栏中的 Time Machine 菜单打开 Time Machine 偏好设置  。或者选择 Apple菜单&gt;系统偏好设置，然后单击 Time Machine。</li>
<li> 取消选择“自动备份”或单击“关闭/打开”开关，具体取决于您在 Time Machine 偏好设置中看到的内容。</li>
<li> 等待几分钟以允许删除本地快照。然后再次打开 Time Machine 。它会记的使用您的备份磁盘。</li>
<li><em>此方案未经本人验证，我使用的是下面的方法</em></li>
</ol></li>
<li><h6 id="toc_6">使用终端命令：</h6>
<ol>
<li>使用 tmutil 命令， <code>tmutil listlocalsnapshotdates</code> 列出所以本地快照</li>
<li>使用 <code>tmutil deletelocalsnapshots xxx</code> 删除对应快照</li>
<li>删除了三个快照后，本地剩余空间从 2G 升为 77G</li>
<li>可选 <code>sudo tmutil disable localsnapshots</code> 从终端关闭本地快照备份功能，和手动关闭 “自动备份” 功能效果一样</li>
</ol></li>
</ul>

<p><img src="https://upload-images.jianshu.io/upload_images/1300265-11dfc80ef3a20757.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/680" alt="image.png"/></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/06/20</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-06-14%2010%3A16%3A35.html">
                
                  <h1>flutter 入坑问题收集(更新中)</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ol>
<li><p>💖字符号不显示</p>
<ol>
<li>You need to set uses-material-design: true in pubspec.yaml for the icons to be included in the app. <a href="https://stackoverflow.com/questions/50786982/flutter-icons-do-not-show">stackoverflow</a></li>
</ol></li>
<li><p>执行更新库：packages get 命令，会卡住，一直lock状态</p>
<ol>
<li>找到自己的flutter的路径 </li>
<li>删除cache中的lockfile <code>rm /Users/xxx/development/flutter/bin/cache/lockfile</code></li>
</ol></li>
</ol>

<pre><code class="language-text">Waiting for another flutter command to release the startup lock...
</code></pre>

<ol>
<li><p>打开安卓模拟器提示 <code>Broken AVD system path. Check your ANDROID_SDK_ROOT value</code></p>
<p>原因是 <code>ANDROID_HOME</code> 和 <code>ANDROID_SDK_ROOT</code> 配置的不对<br/>
在Android studio找到：File/Other Settings/Default Project Structure...<br/>
里面会有 Android sdk location, 此路径才是<code>ANDROID_HOME</code>的路径，将<code>ANDROID_HOME</code> 和 <code>ANDROID_SDK_ROOT</code>更新为此目录就可以了</p></li>
</ol>

<p><img src="https://upload-images.jianshu.io/upload_images/1300265-884d8a870c001517.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="image.png"/></p>

<pre><code class="language-text">4. flutter使用墙内加速
</code></pre>

<p>原文链接 ：<a href="https://flutter.dev/community/china">https://flutter.dev/community/china</a></p>

<pre><code class="language-text">export PUB_HOSTED_URL=https://pub.flutter-io.cn
export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn
</code></pre>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/06/14</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-05-16%2019%3A13%3A19.html">
                
                  <h1>iOS electra 越狱后 TweakInject 不加载插件的问题</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<ol>
<li>使用ssh链接手机，&#39;ssh root@192.168.0.4&#39;, 默认密码 <code>alpine</code></li>
<li>执行下面命令
<code>mv /Library/TweakInject /Library/TweakInject.bak &amp;&amp; ln -s /Library/MobileSubstrate/DynamicLibraries /Library/TweakInject</code></li>
</ol>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/05/16</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
			<div class="article">
                <a class="clearlink" href="2019-03-21%2015%3A46%3A56.html">
                
                  <h1>WKWebView 的性能优化</h1>
                  <div class="a-content">
                      
                      <div class="a-content-text">
                        
                        	<h1 id="toc_0">WKWebView 的性能优化</h1>

<h2 id="toc_1">起因</h2>

<p>随着移动设备性能不断增强，web 页面的性能体验逐渐变得可以接受，又因为 web 开发模式的诸多好处(跨平台，动态更新，减体积，无限扩展)，APP 客户端里出现越来越多内嵌 web 页面），很多 APP 把一些功能模块改成用 H5 实现。</p>

<p>虽然说 H5 页面性能变好了，但如果没针对性地做一些优化，体验还是很糟糕的，主要两部分体验：</p>

<ol>
<li>页面启动白屏时间：打开一个 H5 页面需要做一系列处理，会有一段白屏时间，体验糟糕。</li>
<li>响应流畅度：由于 webkit 的渲染机制，单线程，历史包袱等原因，页面刷新/交互的性能体验不如原生。</li>
</ol>

<p>由于以上原因，公司准备从第一点入手，做 webview 的优化项目(达到秒开         webview )。因为<code>UIWebView</code>在 iOS12 就被标记废弃了，所以决定先从<code>WKWebView</code>入手研究。</p>

<h2 id="toc_2">思路</h2>

<h3 id="toc_3">webview 加载过程</h3>

<p><img src="https://upload-images.jianshu.io/upload_images/1300265-984e4c17d42b38a6.png?imageMogr2/auto-orient/strip%7CimageView2/2/" alt="webview展示流程.png"/></p>

<p>打开一个页面的过程有很多优化点，包括前端和客户端，常规的前端和后端的性能优化已有前辈们总结过最佳实践，主要的是：</p>

<ul>
<li>降低请求量：合并资源，减少 HTTP 请求数，minify / gzip 压缩，webP，lazyLoad。</li>
<li>加快请求速度：预解析DNS，减少域名数，并行加载，CDN 分发。</li>
<li>缓存：HTTP 协议缓存请求，离线缓存 manifest，离线数据缓存 localStorage。</li>
<li>渲染：JS/CSS优化，加载顺序，服务端渲染模板直出。</li>
<li>客户端：预请求web所需数据<br/>
大家可以看出，主要是第三阶段之前，用户看到的页面一直处于白屏。首先要优化的就是这段时间。<br/>
打开一个页面的过程有很多优化点，包括前端和客户端，常规的前端和后端的性能优化已有前辈们总结过最佳实践，主要的是：</li>
</ul>

<p>下面只讲客户端优化部分：</p>

<h4 id="toc_4">减少第一阶段耗时</h4>

<ol>
<li>在使用前预先初始化好 webView，从而减小耗时。</li>
<li>在初始化的同时，通过 Native 来完成一些网络请求等过程，使得 webView 初始化不是完全的阻塞后续过程。</li>
<li>webview 池，可以用两个或多个 webview 重复使用，而不是每次打开 H5 都新建 webview。</li>
</ol>

<h4 id="toc_5">减少第二阶段耗时</h4>

<ol>
<li>离线包
<ol>
<li>预先下载离线包，可以达到立即展示的效果。</li>
<li>离线包可以很方便地根据版本做增量更新。</li>
<li>离线包以压缩包的方式下发，同时会经过加密和校验，防止运营商和第三方对其劫持篡改。</li>
</ol></li>
<li>数据缓存
<ol>
<li>第一次打开会有延迟，但是后续打开就会很快</li>
<li>可以自己控制缓存，方便管理</li>
</ol></li>
<li>客户端代替请求
<ol>
<li>客户端可以在网络请求上做像 DNS 预解析/ IP 直连/长连接/并行请求等更细致的优化</li>
</ol></li>
</ol>

<h2 id="toc_6">难点</h2>

<p>方案是通用的，不区分 UIWebView  和 WKWebView，但是目前很少有以 WKWebView 为目标的方案，那么以上技术方案在 WKWebView 中实现有什么难点呢？<br/>
难点在 <a href="%5Bhttps://developer.apple.com/documentation/foundation/nsurlprotocol%5D(https://developer.apple.com/documentation/foundation/nsurlprotocol)">NSURLProtocol</a></p>

<h4 id="toc_7">WKWebView 无法使用 NSURLProtocol 拦截 http 请求</h4>

<p>这个问题网上早有方案：<br/>
    <code>[WKBrowsingContextController registerSchemeForCustomProtocol:@&quot;schemes&quot;];</code></p>

<h4 id="toc_8">WKWebView 使用 NSURLProtocol 拦截后，HTTPBody的数据会丢失</h4>

<p>从网上克隆了 webkit 进行编译调试，尝试解决 Body 丢失的问题（体验到了啥叫大型项目的编译速度）<br/>
<img src="https://upload-images.jianshu.io/upload_images/1300265-3196befb8d12731e.png?imageMogr2/auto-orient/strip%7CimageView2/2/" alt="image.png"/><br/>
从图上重点标注的地方可以看到：</p>

<ol>
<li><p>WKWebView 的网络请求是在另外一个进程中操作的，然后如果 app 主进程需要拦截请求的话，通过 XPC 来进行两个进程间的通信。</p></li>
<li><p>苹果出于性能或其他考虑，会在给主进程的 URLProtocol 传输请求时将 <code>HTTPBody</code> 和 <code>HTTPBodyStream</code> 置为 nil 。<br/>
<a href="https://github.com/doge1024/webkit/blob/ce05715c8e1034db2e1ac99dde920c41b47b9534/Source/WebKit/Shared/mac/WebCoreArgumentCodersMac.mm#L195-L201">源代码</a></p></li>
</ol>

<h5 id="toc_9">尝试解决方案：</h5>

<ol>
<li> 使用 runtime 黑魔法，在其将 HTTPBody 置为 nil 之前，先保存下来？<br/>
因为网络请求是在其他进程中操作，没有办法在主进程使用 runtime 进行拦截。也就是说在 app 中决定拦截 http 请求的那一刻起，拦截到的请求注定是没有 HTTPBody 的。</li>
<li>使用 任何方式进入到 Networking 进程做一些操作 ？<br/>
尝试了 Mac 端的 XPC demo，XPC 的回调是在各自进程，是不能操作其他进程的。</li>
<li>在 <code>HTTPBody</code> 置为 nil 之前，是否会有代码走到主进程，然后拿到 request 进行操作？<br/>
抱歉，经过测试，在 <code>HTTPBody</code> 置为 nil 之前，主进程不会收到关于 request 的调用</li>
</ol>

<p><img src="https://upload-images.jianshu.io/upload_images/1300265-1e1b75719d7f736d.png?imageMogr2/auto-orient/strip%7CimageView2/2" alt="xpc 的 demo"/></p>

<h2 id="toc_10">解决</h2>

<p>难到就没有任何方法解决了么？无意中看到一个特别有趣的想法又点燃了我的希望。</p>

<p>既然 Networking 进程会将  <code>HTTPBody</code> 置为 nil ，那我要做的就是两点：<br/>
    1. 不让其置为 nil <br/>
    2. 或者在其置为 nil 之前，先将 <code>HTTPBody</code> 保存下来</p>

<p>第一点：上面已经尝试失败；第二点：在 native 端也尝试失败，那在 H5 侧做保存操作呢？<br/>
要拦截的是 H5 的请求，那说明 H5 侧肯定是知道请求参数的。</p>

<h4 id="toc_11">尝试 H5 与 native 结合来解决 <code>HTTPBody</code> 丢失问题</h4>

<p>H5 发起发起请求有三种方式：<br/>
     1. <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLFormElement"><code>Form</code></a></strong><br/>
    2. <strong><a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest"><code>XMLHttpRequest</code></a></strong><br/>
    3. <strong><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API"><code>Fetch</code></a></strong></p>

<p><code>Fetch</code>是在 iOS10 以后支持的，从通用场景看，只需要处理 <code>Form</code> 和 <code>XMLHttpRequest</code> 发起的带 <code>HTTPBody</code> 的请求就可以.</p>

<p>基本所有 H5 开发者，肯定知道 H5 里面也有黑魔法，就是原型：<br/>
<code>XMLHttpRequest</code> 对应的是 <code>XMLHttpRequest.prototype.send</code> 方法<br/>
<code>Form</code> 对应的是 <code>HTMLFormElement.prototype.submit</code> 方法</p>

<p>我们对以上方法使用 <code>WKUserScript</code> 在 <code>WKUserScriptInjectionTimeAtDocumentStart</code> 时机做对应拦截。这样 H5 在发起请求前，先将 POST 的数据发送给 native 存储(<code>WKScriptMessageHandler</code>)。然后在 native 拦截到匹配到的请求，尝试接管，并重新设置 <code>HTTPBody</code>，而且由于拦截到的是 request ，只需要补齐<code>HTTPBody</code>，其他在 h5 中原本对 request 做的各种操作也是存在的，这样就能解决问题了</p>

<p>这个方法提供了一种解决<code>HTTPBody</code> 丢失问题的可能，并且大部分 app，使用应该完全够用。本人已经按照上述方案实现，并接入到 app 中，在解决了一些细节问题后，将各个流程中的 H5 页面走了一遍，目前没有发现不支持的请求。</p>

<hr/>

<p>感兴趣的可以自己下载编译 <a href="https://github.com/doge1024/webkit">webkit</a><br/>
<a href="https://github.com/doge1024/XPCDemo.git">XPCDemo</a></p>

<hr/>

<p>参考：<br/>
<a href="https://tech.meituan.com/2017/06/09/webviewperf.html">WebView性能、体验分析与优化</a><br/>
<a href="https://blog.cnbang.net/tech/3477/">移动 H5 首屏秒开优化方案探讨<br/>
</a> <a href="https://github.com/li6185377/IMYWebLoader.git">IMYWebLoader</a><br/>
<a href="https://github.com/Tencent/VasSonic.git">VasSonic</a></p>

                        
                      </div>
                  </div>
                </a>
                <div class="read-more clearfix">
                  <div class="more-left left">
                  
                    <span class="date">2019/03/21</span>
                    
          				   
                    

                  </div>
                  <div class="more-right right">
                  <span class="comments">
                      

                       
                  </span>
                  </div>
                </div>
              </div><!-- article -->
        
              


			<div class="row">
			  <div class="large-6 columns">
			  <p class="text-left" style="padding-top:25px;">
			   
			  </p>
			  </div>
			  <div class="large-6 columns">
			<p class="text-right" style="padding-top:25px;">
			 <a href="all_1.html">&raquo; Next Page</a> 
			</p>
			  </div>
			</div>
		</div>
	</div><!-- large 8 -->

 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>doge1024</h1>
                <div class="site-des">网站描述</div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="2020-05-27%2010%3A54%3A36.html">WebStorm调试ReactNative</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="2020-05-27%2010%3A45%3A10.html">codepush服务变更，连接不上</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="2020-03-28%2014%3A20%3A52.html">小米手机安装linuxdeploy碰到的问题</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="2020-01-19%2001%3A09%3A37.html">macOS 10.15 pip 安装库失败提示SSL</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="2019-08-06%2001%3A24%3A23.html">读《时间简史》— 解释你无聊时的那些遐想</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>



  














<style type="text/css">
figure{margin: 0;padding: 0;}
figcaption{text-align:center;}

/* PrismJS 1.14.0
 http://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
    color: black;
    background: none;
    text-shadow: 0 1px white;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;
    
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
    text-shadow: none;
    background:#b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
    text-shadow: none;
    background: #b3d4fc;
}

@media print {
    code[class*="language-"],
    pre[class*="language-"] {
        text-shadow: none;
    }
}

/* Code blocks */
pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
    background: #F7F7F7;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
    padding: .1em;
    border-radius: .3em;
    white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: slategray;
}

.token.punctuation {
    color: #999;
}

.namespace {
    opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
    color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
    color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
    color: #9a6e3a;
    background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
    color: #07a;
}

.token.function,
.token.class-name {
    color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
    color: #e90;
}

.token.important,
.token.bold {
    font-weight: bold;
}
.token.italic {
    font-style: italic;
}

.token.entity {
    cursor: help;
}


pre[class*="language-"].line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
    position: relative;
    white-space: inherit;
}

.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 0;
    font-size: 100%;
    left: -3.8em;
    width: 3em; /* works for line-numbers below 1000 lines */
    letter-spacing: -1px;
    border-right: 1px solid #999;

    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;

}

    .line-numbers-rows > span {
        pointer-events: none;
        display: block;
        counter-increment: linenumber;
    }

        .line-numbers-rows > span:before {
            content: counter(linenumber);
            color: #999;
            display: block;
            padding-right: 0.8em;
            text-align: right;
        }

</style>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>



  </body>
</html>
